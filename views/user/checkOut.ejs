<%- include("../partials/user/header.ejs") %>
    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="index.html"><img src="assets/imgs/theme/logo.svg" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="#">
                        <input type="text" placeholder="Search for items…">
                        <button type="submit"><i class="fi-rs-search"></i></button>
                    </form>
                </div>
                <div class="mobile-menu-wrap mobile-header-border">
                    <div class="main-categori-wrap mobile-header-border">
                        <a class="categori-button-active-2" href="#">
                            <span class="fi-rs-apps"></span> Browse Categories
                        </a>
                        <div class="categori-dropdown-wrap categori-dropdown-active-small">
                            <ul>
                                <li><a href="shop-grid-right.html"><i class="evara-font-dress"></i>Women's Clothing</a>
                                </li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-tshirt"></i>Men's Clothing</a>
                                </li>
                                <li> <a href="shop-grid-right.html"><i class="evara-font-smartphone"></i> Cellphones</a>
                                </li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-desktop"></i>Computer &
                                        Office</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-cpu"></i>Consumer
                                        Electronics</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-home"></i>Home & Garden</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-high-heels"></i>Shoes</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-teddy-bear"></i>Mother &
                                        Kids</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-kite"></i>Outdoor fun</a></li>
                            </ul>
                        </div>
                    </div>
                    <!-- mobile menu start -->
                    <nav>
                        <ul class="mobile-menu">
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                    href="index.html">Home</a>
                                <ul class="dropdown">
                                    <li><a href="index.html">Home 1</a></li>
                                    <li><a href="index-2.html">Home 2</a></li>
                                    <li><a href="index-3.html">Home 3</a></li>
                                    <li><a href="index-4.html">Home 4</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                    href="shop-grid-right.html">shop</a>
                                <ul class="dropdown">
                                    <li><a href="shop-grid-right.html">Shop Grid – Right Sidebar</a></li>
                                    <li><a href="shop-grid-left.html">Shop Grid – Left Sidebar</a></li>
                                    <li><a href="shop-list-right.html">Shop List – Right Sidebar</a></li>
                                    <li><a href="shop-list-left.html">Shop List – Left Sidebar</a></li>
                                    <li><a href="shop-fullwidth.html">Shop - Wide</a></li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Single Product</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Product – Right Sidebar</a></li>
                                            <li><a href="shop-product-left.html">Product – Left Sidebar</a></li>
                                            <li><a href="shop-product-full.html">Product – No sidebar</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="shop-filter.html">Shop – Filter</a></li>
                                    <li><a href="shop-wishlist.html">Shop – Wishlist</a></li>
                                    <li><a href="shop-cart.html">Shop – Cart</a></li>
                                    <li><a href="shop-checkout.html">Shop – Checkout</a></li>
                                    <li><a href="shop-compare.html">Shop – Compare</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Mega
                                    menu</a>
                                <ul class="dropdown">
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Women's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Dresses</a></li>
                                            <li><a href="shop-product-right.html">Blouses & Shirts</a></li>
                                            <li><a href="shop-product-right.html">Hoodies & Sweatshirts</a></li>
                                            <li><a href="shop-product-right.html">Women's Sets</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Men's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Jackets</a></li>
                                            <li><a href="shop-product-right.html">Casual Faux Leather</a></li>
                                            <li><a href="shop-product-right.html">Genuine Leather</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Technology</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Gaming Laptops</a></li>
                                            <li><a href="shop-product-right.html">Ultraslim Laptops</a></li>
                                            <li><a href="shop-product-right.html">Tablets</a></li>
                                            <li><a href="shop-product-right.html">Laptop Accessories</a></li>
                                            <li><a href="shop-product-right.html">Tablet Accessories</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                    href="blog-category-fullwidth.html">Blog</a>
                                <ul class="dropdown">
                                    <li><a href="blog-category-grid.html">Blog Category Grid</a></li>
                                    <li><a href="blog-category-list.html">Blog Category List</a></li>
                                    <li><a href="blog-category-big.html">Blog Category Big</a></li>
                                    <li><a href="blog-category-fullwidth.html">Blog Category Wide</a></li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Single Product Layout</a>
                                        <ul class="dropdown">
                                            <li><a href="blog-post-left.html">Left Sidebar</a></li>
                                            <li><a href="blog-post-right.html">Right Sidebar</a></li>
                                            <li><a href="blog-post-fullwidth.html">No Sidebar</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Pages</a>
                                <ul class="dropdown">
                                    <li><a href="page-about.html">About Us</a></li>
                                    <li><a href="page-contact.html">Contact</a></li>
                                    <li><a href="page-account.html">My Account</a></li>
                                    <li><a href="page-login-register.html">login/register</a></li>
                                    <li><a href="page-purchase-guide.html">Purchase Guide</a></li>
                                    <li><a href="page-privacy-policy.html">Privacy Policy</a></li>
                                    <li><a href="page-terms.html">Terms of Service</a></li>
                                    <li><a href="page-404.html">404 Page</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Language</a>
                                <ul class="dropdown">
                                    <li><a href="#">English</a></li>
                                    <li><a href="#">French</a></li>
                                    <li><a href="#">German</a></li>
                                    <li><a href="#">Spanish</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                    <!-- mobile menu end -->
                </div>
                <div class="mobile-header-info-wrap mobile-header-border">
                    <div class="single-mobile-header-info mt-30">
                        <a href="page-contact.html"> Our location </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="page-login-register.html">Log In / Sign Up </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="#">(+01) - 2345 - 6789 </a>
                    </div>
                </div>
                <div class="mobile-social-icon">
                    <h5 class="mb-15 text-grey-4">Follow Us</h5>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">

                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span> <a
                                    href="#coupon" data-bs-toggle="collapse" class="collapsed"
                                    aria-expanded="false">Click here to enter your code</a></span>
                        </div>
                        <div class="panel-collapse collapse coupon_form " id="coupon">
                            <div class="panel-body">
                                <p class="mb-30 font-sm">If you have a coupon code, please apply it below.</p>
                                <form method="post">
                                    <div class="form-group">
                                        <input type="text" placeholder="Enter Coupon Code...">
                                    </div>
                                    <div class="form-group">
                                        <button class="btn  btn-md" name="login">Apply Coupon</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h3>Billing Details</h3>
                        </div>

                        <div class="form-group">
                            <input type="text" required="" name="fname" placeholder="<%=user.name%>"
                                value="<%=user.name%>" />
                        </div>

                        <div class="form-group">
                            <label for="addressSelect">Select Address</label>
                            <select id="addressSelect" name="selectedAddress" class="form-control" required>
                                <% address?.address?.forEach((add) => { %>
                                    <option value="<%= add._id %>">
                                        <%= add.addressType %>, <%= add.city %>, <%= add.landMark %>, <%= add.state %>,
                                        <%= add.pincode %>, <%= add.phone %>, <%= add.alternativePhone %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn mt-3" data-bs-toggle="modal"
                                data-bs-target="#addAddressModal">
                                Add Address
                            </button>
                        </div>
                    </div>

                    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form id="addAddressForm" action="/checkAddAddress" method = 'post'>
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label for="addType">Address Type</label>
                                            <input type="text" class="form-control" id="addType" name="addressType"
                                                required />
                                        </div>
                                        <div class="form-group">
                                            <label for="addName">Name</label>
                                            <input type="text" class="form-control" id="addName" name="name" required />
                                        </div>
                                        <div class="form-group">
                                            <label for="addCity">City</label>
                                            <input type="text" class="form-control" id="addCity" name="city" required />
                                        </div>
                                        <div class="form-group">
                                            <label for="addState">State</label>
                                            <input type="text" class="form-control" id="addState" name="state"
                                                required />
                                        </div>
                                        <div class="form-group">
                                            <label for="addPincode">Pincode</label>
                                            <input type="text" class="form-control" id="addPincode" name="pincode"
                                                required />
                                        </div>
                                        <div class="form-group">
                                            <label for="addLandmark">Landmark</label>
                                            <input type="text" class="form-control" id="addLandmark" name="landMark" />
                                        </div>
                                        <div class="form-group">
                                            <label for="addPhone">Phone</label>
                                            <input type="text" class="form-control" id="addPhone" name="phone"
                                                required />
                                        </div>
                                        <div class="form-group">
                                            <label for="addAltPhone">Alternate Phone</label>
                                            <input type="text" class="form-control" id="addAltPhone" name="alternativePhone" />
                                        </div>
                                        
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            Close
                                        </button>
                                        <button type="submit" id="submitButton" class="btn btn-primary">Add address</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% cart.items.forEach(item=> { %>
                                            <tr>
                                                <td class="image product-thumbnail"><img
                                                        src="/uploads/image/<%= item.productId.productImage[0] %>"
                                                        alt="<%= item.productId.productName %>"></td>
                                                <td>
                                                    <h5><a href="/productDetails/<%= item.productId._id %>">
                                                            <%= item.productId.productName %>
                                                        </a></h5>
                                                    <span class="product-qty">x <%= item.quantity %></span>
                                                </td>
                                                <td>₹<%= item.productId.salesPrice %>
                                                </td>
                                                <% }) %>
                                            </tr>
                                            <tr>
                                                <th>SubTotal</th>
                                                <td class="product-subtotal" colspan="2">₹ <%= cart.items.reduce((sum,
                                                        item)=> sum +=
                                                        item.productId.salesPrice * item.quantity, 0) %></td>
                                            </tr>
                                            <tr>
                                                <th>Shipping</th>
                                                <td colspan="2"><em>Free Shipping</em></td>
                                            </tr>
                                            <tr>
                                                <th>Total</th>
                                                <td colspan="2" class="product-subtotal"><span
                                                        class="font-xl text-brand fw-900">
                                                        ₹ <%= cart.items.reduce((sum, item)=> sum +=
                                                            item.productId.salesPrice * item.quantity, 0) %></span></td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div style="margin-top: 10px">
                                        <input id="cod" type="radio" name="paymentMethod" value="COD"
                                            style="width: 15px; height: 15px; margin-right: 5px; cursor: pointer;" required/>
                                        <label for="cod" style="cursor: pointer; font-size: 14px">Cash On Delivery</label>
                                      </div>
                                </div>
                            </div>
                            <button id="placeOrderButton" class="btn btn-fill-out btn-block mt-30">Place Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <%- include('../partials/user/footer.ejs') %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

function validateAddressForm() {
    let isValid = true;
    const requiredFields = ["addType", "addName", "addCity", "addLandmark", "addState", "addPincode", "addPhone", "addAltPhone"];

    // Regular expressions for validation
    const namePattern = /^[A-Za-z\s]+$/; // Only letters and spaces
    const pincodePattern = /^\d{6}$/; // Exactly 6-digit numbers
    const phonePattern = /^[6-9]\d{9}$/; // Valid Indian phone numbers (starting with 6-9)

    requiredFields.forEach(function(field) {
        const input = document.getElementById(field);
        let inputValue = input.value.trim();
        const errorElement = document.getElementById(field + '-error');

        if (inputValue === "") {
            showError(field, "This field is required.");
            isValid = false;
        } else {
            clearError(field);
        }
    });

    const name = document.getElementById('addName').value.trim();
    const city = document.getElementById('addCity').value.trim();
    const landMark = document.getElementById('addLandmark').value.trim();
    const state = document.getElementById('addState').value.trim();
    const pincode = document.getElementById('addPincode').value.trim();
    const phone = document.getElementById('addPhone').value.trim();
    const alternativePhone = document.getElementById('addAltPhone').value.trim();

    // Name, City, Landmark & State validation (Only letters and spaces)
    if (!namePattern.test(name)) {
        showSwalError("Name should contain only letters.");
        isValid = false;
    }
    if (!namePattern.test(city)) {
        showSwalError("City should contain only letters.");
        isValid = false;
    }
    if (landMark && !namePattern.test(landMark)) {
        showSwalError("Landmark should contain only letters.");
        isValid = false;
    }
    if (!namePattern.test(state)) {
        showSwalError("State should contain only letters.");
        isValid = false;
    }

    // Pincode validation (Exactly 6-digit numbers)
    if (!pincodePattern.test(pincode)) {
        showSwalError("Pincode must be exactly 6 digits.");
        isValid = false;
    }

    // Phone number validation (10-digit valid numbers starting with 6-9)
    if (!phonePattern.test(phone)) {
        showSwalError("Phone number must be a valid 10-digit number starting with 6-9.");
        isValid = false;
    }
    if (alternativePhone && !phonePattern.test(alternativePhone)) {
        showSwalError("Alternate phone number must be a valid 10-digit number starting with 6-9.");
        isValid = false;
    }

    // Ensure phone and alternate phone are not the same
    if (phone === alternativePhone) {
        showSwalError("Phone number and alternate phone number must be different.");
        isValid = false;
    }

    return isValid;
}

// Function to show inline error message
function showError(field, message) {
    let errorElement = document.getElementById(field + '-error');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.className = "text-danger";
        errorElement.id = field + '-error';
        document.getElementById(field).parentNode.appendChild(errorElement);
    }
    errorElement.textContent = message;
}

// Function to clear inline error message
function clearError(field) {
    const errorElement = document.getElementById(field + '-error');
    if (errorElement) {
        errorElement.remove();
    }
}

// Function to show SweetAlert errors
function showSwalError(message) {
    Swal.fire({
        icon: 'error',
        title: 'Validation Error',
        text: message,
    });
}


document.getElementById('addAddressForm').addEventListener('submit', function (event) {
            event.preventDefault();

            if (validateAddressForm()) {
                const formData = new FormData(this);
                const url = this.getAttribute('action');

                fetch(url, {
                    method: 'POST',
                    body: new URLSearchParams(formData),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire({
                                title: 'Success!',
                                text: 'Address added successfully',
                                icon: 'success',
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = '/checkOut';
                            });
                        } else {
                            throw new Error('Network response was not ok');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to add address. Please try again.',
                            icon: 'error'
                        });
                    });
            }
        });
// ----------------------------------------------------------------------------------

//         const placeOrderButton = document.querySelector(".btn-fill-out");
// const addressSelect = document.getElementById("addressSelect");
// const paymentRadios = document.getElementsByName("paymentMethod");

// let orderId;
// const cartItems = JSON.parse('<%- JSON.stringify(cartItems) %>');
// const totalAmount = '<%= cart.items.reduce((sum, item) => sum + item.productId.salesPrice * item.quantity, 0) %>';

// const totalElement = document.querySelector(".product-subtotal span");
// const originalTotal = parseFloat(totalElement.textContent.replace("₹", "").trim());

// placeOrderButton.addEventListener("click", async (event) => {
//     event.preventDefault();
//     console.log("Place Order button clicked");

//     const selectedAddressId = addressSelect.value;
//     if (!selectedAddressId) {
//         Swal.fire({
//             toast: true,
//             position: 'top-end',
//             icon: 'warning',
//             title: "Please select an address to proceed.",
//             showConfirmButton: false,
//             timer: 3000
//         });
//         return;
//     }

//     const selectedPaymentMethod = Array.from(paymentRadios).find(radio => radio.checked)?.value;
//     if (!selectedPaymentMethod) {
//         Swal.fire({
//             toast: true,
//             position: 'top-end',
//             icon: 'warning',
//             title: "Please select a payment method.",
//             showConfirmButton: false,
//             timer: 3000
//         });
//         return;
//     }

//     const orderData = {
//         addressId: selectedAddressId,
//         items: cartItems.map(item => ({
//             productId: item.productId._id,
//             quantity: item.quantity,
//         })),
//         totalAmount: totalAmount, 
//         paymentMethod: selectedPaymentMethod,
//     };

//     try {
//         const response = await fetch("/checkout/process", {
//             method: "POST",
//             headers: { "Content-Type": "application/json" },
//             body: JSON.stringify(orderData),
//         });

//         const result = await response.json();
//         if (response.ok) {
//             orderId = result.orderId;

//             if (selectedPaymentMethod === "COD") {
//                 Swal.fire({
//                     toast: true,
//                     position: 'top-end',
//                     icon: 'success',
//                     title: "Order placed successfully with COD!",
//                     showConfirmButton: false,
//                     timer: 3000
//                 });
//                 window.location.href = "/payemntSuccess";
//             } 
//             else {
//             throw new Error(result.message || "Failed to place order. Please try again.");
//         }
//     }
//     } catch (error) {
//         console.error("Error placing order:", error);
//         Swal.fire({
//             icon: 'error',
//             title: "An error occurred while placing your order.",
//             text: error.message,
//             showConfirmButton: true,
//         }).then(() => {
//             window.location.href = "/paymentFail";
//         });
//     }
// });



document.getElementById("placeOrderButton").addEventListener("click", function () {
    const selectedAddress = document.getElementById("addressSelect").value;
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    const totalAmount = '<%= cart.items.reduce((sum, item)=> sum += item.productId.salesPrice * item.quantity, 0) %>'

    // Check if address is selected
    if (!selectedAddress) {
        Swal.fire({
            icon: "error",
            title: "Address Required",
            text: "Please select an address before placing the order.",
        });
        return;
    }

    // Check if payment method (COD) is selected
    if (!paymentMethod) {
        Swal.fire({
            icon: "error",
            title: "Payment Method Required",
            text: "Please select Cash on Delivery (COD).",
        });
        return;
    }

    // Order Data to Send
    const orderData = {
        addressId: selectedAddress,
        paymentMethod: paymentMethod.value,
        totalAmount: totalAmount
    };

    console.log(orderData);
    
    
    fetch("/checkout/process", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body:JSON.stringify({orderData})
    }).then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: "success",
                title: "Order Placed!",
                text: "Your order has been successfully placed.",
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = "/paymentSuccess";
            });
        } else {
            //Order failed
            Swal.fire({
                icon: "error",
                title: "Order Failed",
                text: dat.message
            });
        }
    })
    .catch(error => {
        console.error("Error placing order:", error);
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "Unable to place the order. Please try again."
        });
    });
});

    </script>
<%- include("../partials/user/header.ejs") %>

<style>
/* General container styling */
#couponContainer {
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 20px;
  box-sizing: border-box;
}

/* Individual coupon card styling */
.coupon {
  background-color: #f9f9f9;
  border: 2px solid #ddd;
  border-radius: 10px;
  padding: 20px;
  width: 100%;
  max-width: 300px;
  height: auto;
  box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.1);
  text-align: center;
  transition: transform 0.2s ease-in-out;
  position: relative;
}

.coupon:hover {
  transform: scale(1.05);
}

/* Coupon heading */
.coupon h3 {
  font-size: 1.2rem;
  color: #0b5549;
  margin-bottom: 5px;
}

/* Coupon details */
.coupon p {
  font-size: 0.9rem;
  color: #555;
  margin: 3px 0;
}

/* Copy button styling */
.copy-btn {
  background-color: #0b5658;
  color: #fff;
  border: none;
  padding: 8px 15px;
  cursor: pointer;
  border-radius: 5px;
  transition: background-color 0.3s;
}

.copy-btn:hover {
  background-color: #0056b3;
}

/* Responsive design */
@media (min-width: 600px) {
  #couponContainer {
    justify-content: center;
  }
}

@media (min-width: 900px) {
  .coupon {
    width: 100%;
    max-width: 350px;
  }
}

.error-message {
    color: red;
    font-size: 0.9em;
    margin-bottom: 5px;
}

</style>

<div id="preloader-active">
    <div class="preloader d-flex align-items-center justify-content-center">
        <div class="preloader-inner position-relative">
            <div class="text-center">
                <h5 class="mb-5">Now Loading</h5>
                <div class="loader">
                    <div class="bar bar1"></div>
                    <div class="bar bar2"></div>
                    <div class="bar bar3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="index.html"><img src="assets/imgs/theme/logo.svg" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="#">
                        <input type="text" placeholder="Search for items…">
                        <button type="submit"><i class="fi-rs-search"></i></button>
                    </form>
                </div>
                <div class="mobile-menu-wrap mobile-header-border">
                    <div class="main-categori-wrap mobile-header-border">
                        <a class="categori-button-active-2" href="#">
                            <span class="fi-rs-apps"></span> Browse Categories
                        </a>
                        <div class="categori-dropdown-wrap categori-dropdown-active-small">
                            <ul>
                                <li><a href="shop-grid-right.html"><i class="evara-font-dress"></i>Women's Clothing</a>
                                </li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-tshirt"></i>Men's Clothing</a>
                                </li>
                                <li> <a href="shop-grid-right.html"><i class="evara-font-smartphone"></i> Cellphones</a>
                                </li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-desktop"></i>Computer &
                                        Office</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-cpu"></i>Consumer
                                        Electronics</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-home"></i>Home & Garden</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-high-heels"></i>Shoes</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-teddy-bear"></i>Mother &
                                        Kids</a></li>
                                <li><a href="shop-grid-right.html"><i class="evara-font-kite"></i>Outdoor fun</a></li>
                            </ul>
                        </div>
                    </div>
                    <!-- mobile menu start -->
                    <nav>
                        <ul class="mobile-menu">
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                    href="index.html">Home</a>
                                <ul class="dropdown">
                                    <li><a href="index.html">Home 1</a></li>
                                    <li><a href="index-2.html">Home 2</a></li>
                                    <li><a href="index-3.html">Home 3</a></li>
                                    <li><a href="index-4.html">Home 4</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                    href="shop-grid-right.html">shop</a>
                                <ul class="dropdown">
                                    <li><a href="shop-grid-right.html">Shop Grid – Right Sidebar</a></li>
                                    <li><a href="shop-grid-left.html">Shop Grid – Left Sidebar</a></li>
                                    <li><a href="shop-list-right.html">Shop List – Right Sidebar</a></li>
                                    <li><a href="shop-list-left.html">Shop List – Left Sidebar</a></li>
                                    <li><a href="shop-fullwidth.html">Shop - Wide</a></li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Single Product</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Product – Right Sidebar</a></li>
                                            <li><a href="shop-product-left.html">Product – Left Sidebar</a></li>
                                            <li><a href="shop-product-full.html">Product – No sidebar</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="shop-filter.html">Shop – Filter</a></li>
                                    <li><a href="shop-wishlist.html">Shop – Wishlist</a></li>
                                    <li><a href="shop-cart.html">Shop – Cart</a></li>
                                    <li><a href="shop-checkout.html">Shop – Checkout</a></li>
                                    <li><a href="shop-compare.html">Shop – Compare</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Mega
                                    menu</a>
                                <ul class="dropdown">
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Women's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Dresses</a></li>
                                            <li><a href="shop-product-right.html">Blouses & Shirts</a></li>
                                            <li><a href="shop-product-right.html">Hoodies & Sweatshirts</a></li>
                                            <li><a href="shop-product-right.html">Women's Sets</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Men's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Jackets</a></li>
                                            <li><a href="shop-product-right.html">Casual Faux Leather</a></li>
                                            <li><a href="shop-product-right.html">Genuine Leather</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Technology</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Gaming Laptops</a></li>
                                            <li><a href="shop-product-right.html">Ultraslim Laptops</a></li>
                                            <li><a href="shop-product-right.html">Tablets</a></li>
                                            <li><a href="shop-product-right.html">Laptop Accessories</a></li>
                                            <li><a href="shop-product-right.html">Tablet Accessories</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                    href="blog-category-fullwidth.html">Blog</a>
                                <ul class="dropdown">
                                    <li><a href="blog-category-grid.html">Blog Category Grid</a></li>
                                    <li><a href="blog-category-list.html">Blog Category List</a></li>
                                    <li><a href="blog-category-big.html">Blog Category Big</a></li>
                                    <li><a href="blog-category-fullwidth.html">Blog Category Wide</a></li>
                                    <li class="menu-item-has-children"><span class="menu-expand"></span><a
                                            href="#">Single Product Layout</a>
                                        <ul class="dropdown">
                                            <li><a href="blog-post-left.html">Left Sidebar</a></li>
                                            <li><a href="blog-post-right.html">Right Sidebar</a></li>
                                            <li><a href="blog-post-fullwidth.html">No Sidebar</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Pages</a>
                                <ul class="dropdown">
                                    <li><a href="page-about.html">About Us</a></li>
                                    <li><a href="page-contact.html">Contact</a></li>
                                    <li><a href="page-account.html">My Account</a></li>
                                    <li><a href="page-login-register.html">login/register</a></li>
                                    <li><a href="page-purchase-guide.html">Purchase Guide</a></li>
                                    <li><a href="page-privacy-policy.html">Privacy Policy</a></li>
                                    <li><a href="page-terms.html">Terms of Service</a></li>
                                    <li><a href="page-404.html">404 Page</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children"><span class="menu-expand"></span><a href="#">Language</a>
                                <ul class="dropdown">
                                    <li><a href="#">English</a></li>
                                    <li><a href="#">French</a></li>
                                    <li><a href="#">German</a></li>
                                    <li><a href="#">Spanish</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                    <!-- mobile menu end -->
                </div>
                <div class="mobile-header-info-wrap mobile-header-border">
                    <div class="single-mobile-header-info mt-30">
                        <a href="page-contact.html"> Our location </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="page-login-register.html">Log In / Sign Up </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="#">(+01) - 2345 - 6789 </a>
                    </div>
                </div>
                <div class="mobile-social-icon">
                    <h5 class="mb-15 text-grey-4">Follow Us</h5>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-facebook.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-twitter.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-instagram.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-pinterest.svg" alt=""></a>
                    <a href="#"><img src="assets/imgs/theme/icons/icon-youtube.svg" alt=""></a>
                </div>
            </div>
        </div>
    </div>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow">Home</a>
                    <span></span> Shop
                    <span></span> Checkout
                </div>
            </div>
        </div>
        <section class="mt-50 mb-50">
            <div class="container">
                <div class="row">

                    <div class="col-lg-6">
                        <div class="toggle_info">
                            <span><i class="fi-rs-label mr-10"></i><span class="text-muted">Have a coupon?</span>
                            <a href="#" data-bs-toggle="modal" data-bs-target="#couponModal">Click here to view available coupons</a></span>
                        </div>
                        <!-- Coupon Modal -->
    <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <% if (coupons && coupons.length > 0) { %>
                        <div class="coupon-list">
                            <% coupons.forEach(coupon => { %>
                                <div class="coupon-item p-3 mb-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1"><%= coupon.name %></h6>
                                            <p class="mb-1 text-success">Save %<%= coupon.offerPercentage %></p>
                                            <small class="text-muted">Minimum Purchase: ₹<%= coupon.minimumprice %></small>
                                            <br>
                                            <small class="text-muted">Expires: <%= new Date(coupon.expiryDate).toLocaleDateString() %></small>
                                        </div>
                                        <button class="btn btn-sm btn-primary apply-coupon" 
                                                data\-coupon-id="<%= coupon._id %>"
                                                data-coupon-code="<%= coupon.couponCode %>"
                                                data-bs-dismiss="modal">
                                            Apply
                                        </button>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No active coupons available at the moment.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
        </div>
        <button id="clearCoupon" class="btn btn-fill-out btn-block mt-30">Remove Discount</button>

                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="divider mt-50 mb-50"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-25">
                            <h3>Billing Details</h3>
                        </div>

                        <div class="form-group">
                            <input type="text" required="" name="fname" placeholder="<%=user.name%>"
                                value="<%=user.name%>" />
                        </div>

                        <div class="form-group">
                            <label for="addressSelect">Select Address</label>
                            <select id="addressSelect" name="selectedAddress" class="form-control" required>
                                <% address?.address?.forEach((add) => { %>
                                    <option value="<%= add._id %>">
                                        <%= add.addressType %>, <%= add.city %>, <%= add.landMark %>, <%= add.state %>,
                                        <%= add.pincode %>, <%= add.phone %>, <%= add.alternativePhone %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn mt-3" data-bs-toggle="modal"
                                data-bs-target="#addAddressModal">
                                Add Address
                            </button>
                        </div>
                    </div>

                    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <form id="addAddressForm" action="/checkAddAddress" method="post">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="form-group">
                                            <label for="addType">Address Type</label>
                                            <input type="text" class="form-control" id="addType" name="addressType"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addName">Name</label>
                                            <input type="text" class="form-control" id="addName" name="name"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addCity">City</label>
                                            <input type="text" class="form-control" id="addCity" name="city"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addState">State</label>
                                            <input type="text" class="form-control" id="addState" name="state"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addPincode">Pincode</label>
                                            <input type="text" class="form-control" id="addPincode" name="pincode"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addLandmark">Landmark</label>
                                            <input type="text" class="form-control" id="addLandmark" name="landMark"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addPhone">Phone</label>
                                            <input type="text" class="form-control" id="addPhone" name="phone"/>
                                        </div>
                                        <div class="form-group">
                                            <label for="addAltPhone">Alternate Phone</label>
                                            <input type="text" class="form-control" id="addAltPhone" name="alternativePhone"/>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="submit" id="submitButton" class="btn btn-primary">Add address</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="order_review">
                            <div class="mb-20">
                                <h4>Your Orders</h4>
                            </div>
                            <div class="table-responsive order_table text-center">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Product</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% cart.items.forEach(item=> { %>
                                            <tr>
                                                <td class="image product-thumbnail"><img
                                                        src="/uploads/image/<%= item.productId.productImage[0] %>"
                                                        alt="<%= item.productId.productName %>"></td>
                                                <td>
                                                    <h5><a href="/productDetails/<%= item.productId._id %>">
                                                            <%= item.productId.productName %>
                                                        </a></h5>
                                                    <span class="product-qty">x <%= item.quantity %></span>
                                                </td>
                                                <td>₹<%= item.productId.salesPrice %>
                                                </td>
                                                <% }) %>
                                            </tr>
                                            <tr>
                                                <th>SubTotal</th>
                                                <td class="product-subtotal" colspan="2">₹ <%= cart.items.reduce((sum,
                                                        item)=> sum +=
                                                        item.productId.salesPrice * item.quantity, 0) %></td>
                                            </tr>
                                            <tr>
                                                <th>Shipping</th>
                                                <td colspan="2"><em>Free Shipping</em></td>
                                            </tr>
                                            <tr>
                                                <th>Coupon Discount</th>
                                                <td colspan="2" class="coupon-discount">
                                                    <span class="font-xl text-brand fw-900 discount-amount"
                                                      >₹0</span
                                                    >
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Total</th>
                                                <td colspan="2" class="product-subtotal"><span
                                                        class="font-xl text-brand fw-900">
                                                        ₹ <%= cart.items.reduce((sum, item)=> sum +=
                                                            item.productId.salesPrice * item.quantity, 0) %></span></td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="bt-1 border-color-1 mt-30 mb-30"></div>
                            <div class="payment_method">
                                <div class="mb-25">
                                    <h5>Payment</h5>
                                </div>
                                <div class="payment_option">
                                    <div style="margin-top: 10px">
                                        <%if(cart.items.reduce((sum, item) => sum += item.productId.salesPrice * item.quantity, 0) <10000){%>
                                        <input id="cod" type="radio" name="paymentMethod" value="COD"
                                            style="width: 15px; height: 15px; margin-right: 5px; cursor: pointer;" required/>
                                        <label for="cod" style="cursor: pointer; font-size: 14px">Cash On Delivery</label>
                                        <%}else{%>
                                            <div style="margin-bottom: 10px"><p class="text-danger">Cash on Delivery is only available for orders under ₹10000. </p></div>
                                            <%}%>
                                      </div>
                                      <div style="margin-top: 10px">
                                        <input id="online" type="radio" name="paymentMethod" value="online"
                                            style="width: 15px; height: 15px; margin-right: 5px; cursor: pointer;" required/>
                                        <label for="online" style="cursor: pointer; font-size: 14px">Online Payment</label>
                                      </div>
                                      <div style="margin-top: 10px">
                                        <input id="Wallet" type="radio" name="paymentMethod" value="Wallet"
                                            style="width: 15px; height: 15px; margin-right: 5px; cursor: pointer;" required/>
                                        <label for="Wallet" style="cursor: pointer; font-size: 14px">Wallet</label>
                                      </div>
                                </div>
                            </div>
                            <button id="placeOrderButton" class="btn btn-fill-out btn-block mt-30">Place Order</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <%- include('../partials/user/footer.ejs') %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    

    <script>

const originalTotal = '<%= cart.items.reduce((sum, item) => sum + item.productId.salesPrice * item.quantity, 0) %>';

function copyCode(couponId) {
    const couponCodeElement = document.getElementById(`couponCode-${couponId}`);
    const couponCode = couponCodeElement.innerText;

    navigator.clipboard.writeText(couponCode).then(() => {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: `Coupon code "${couponCode}" copied to clipboard!`,
            showConfirmButton: false,
            timer: 3000,
        });
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}

function validateAddressForm() {
    let isValid = true;
    const allFields = ["addType", "addName", "addCity", "addState", "addPincode", "addLandmark", "addPhone", "addAltPhone"];
    
    // Patterns
    const letterPattern = /^[A-Za-z\s]+$/;  // Only letters and spaces
    const pincodePattern = /^(?!(\d)\1{5})\d{6}$/;  // 6 digits, no repeating numbers
    const phonePattern = /^(?!(\d)\1{9})[6-9]\d{9}$/;  // 10 digits, starting 6-9, no repeating numbers

    // Function to check space rules
    function isValidSpaceFormat(value) {
        return !(/^\s|\s$/.test(value) || /^\s+$/.test(value) || /\s\s+/.test(value));
    }

    // Clear all previous errors first
    allFields.forEach(field => clearError(field));

    // Validate all fields
    allFields.forEach(function(field) {
        const input = document.getElementById(field);
        const value = input.value.trim();

        // Check if field is empty
        if (value === "") {
            showError(field, "This field is required");
            isValid = false;
            return;
        }

        // Check space rules
        if (!isValidSpaceFormat(input.value)) {
            showError(field, "Cannot start/end with spaces or have consecutive spaces");
            isValid = false;
            return;
        }

        // Specific field validations
        switch(field) {
            case "addType":
            case "addName":
            case "addCity":
            case "addState":
            case "addLandmark":
                if (!letterPattern.test(value) || /\d/.test(value) || /[^A-Za-z\s]/.test(value)) {
                    showError(field, "Only letters and spaces allowed");
                    isValid = false;
                }
                break;

            case "addPincode":
                if (!pincodePattern.test(value) || /\s/.test(value)) {
                    showError(field, "Must be 6 unique digits");
                    isValid = false;
                }
                break;

            case "addPhone":
            case "addAltPhone":
                if (!phonePattern.test(value) || /\s/.test(value)) {
                    showError(field, "Must be 10 unique digits starting with 6-9");
                    isValid = false;
                }
                break;
        }
    });

    // Check for phone number duplication
    const phone = document.getElementById('addPhone').value.trim();
    const altPhone = document.getElementById('addAltPhone').value.trim();
    if (phone === altPhone) {
        showError('addAltPhone', "Must be different from Phone");
        isValid = false;
    }

    return isValid;
}

function showError(field, message) {
    clearError(field); // Clear existing error first
    const input = document.getElementById(field);
    const errorElement = document.createElement('div');
    errorElement.className = "text-danger error-message";
    errorElement.id = field + '-error';
    errorElement.textContent = message;
    input.parentNode.insertBefore(errorElement, input);
}

function clearError(field) {
    const errorElement = document.getElementById(field + '-error');
    if (errorElement) {
        errorElement.remove();
    }
}

document.getElementById('addAddressForm').addEventListener('submit', function (event) {
    event.preventDefault();

    if (validateAddressForm()) {
        const formData = new FormData(this);
        const url = this.getAttribute('action');

        fetch(url, {
            method: 'POST',
            body: new URLSearchParams(formData),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (response.ok) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Address added successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '/checkOut';
                });
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Failed to add address. Please try again.',
                icon: 'error'
            });
        });
    }
});

document.getElementById('clearCoupon').addEventListener('click', function () {
    Swal.fire({
        title: 'Remove Discount',
        text: 'Do you want to remove the coupon discount?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes',
        cancelButtonText: 'No'
    }).then((result) => {
        if (result.isConfirmed) {
            const discountElement = document.querySelector('.discount-amount');
            const totalElement = document.querySelector('.product-subtotal .font-xl');

            discountElement.textContent = '₹0';
            totalElement.textContent = `₹${Math.floor(originalTotal)}`;

            localStorage.removeItem('appliedCoupon');

            Swal.fire({
                icon: 'success',
                title: 'Discount Removed',
                text: 'The coupon discount has been removed.',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
});

let onlineCoupon;
document.getElementById("placeOrderButton").addEventListener("click", async function () {
    const selectedAddress = document.getElementById("addressSelect").value;
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    const totalAmountElement = document.querySelector('.product-subtotal .font-xl');
    const totalAmount = totalAmountElement.textContent.trim().replace('₹', '').trim();
    let couponInfo = localStorage.getItem('appliedCoupon') 
        ? JSON.parse(localStorage.getItem('appliedCoupon')) 
        : null;

    if (!selectedAddress) {
        Swal.fire({
            icon: "error",
            title: "Address Required",
            text: "Please select an address before placing the order.",
        });
        return;
    }

    if (!paymentMethod) {
        Swal.fire({
            icon: "error",
            title: "Payment Method Required",
            text: "Please select a payment method.",
        });
        return;
    }
    
    const orderData = {
        addressId: selectedAddress,
        paymentMethod: paymentMethod.value,
        totalAmount: totalAmount,
        coupon: couponInfo ? {
            code: couponInfo.code,
            discountAmount: couponInfo.discountAmount
        } : null
    };

    if (paymentMethod.value === "COD") {
        fetch("/checkout/process", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                localStorage.removeItem('appliedCoupon');
                
                Swal.fire({
                    icon: "success",
                    title: "Order Placed!",
                    text: "Your order has been successfully placed.",
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = "/paymentSuccess";
                });
            } else {
                Swal.fire({ icon: "error", title: "Order Failed", text: data.message });
            }
        })
        .catch(error => {
            console.error("Error placing order:", error);
            Swal.fire({ icon: "error", title: "Error", text: "Unable to place the order. Please try again." });
        });
    } if (paymentMethod.value === "online") {
        const response = await fetch("/create-razorpay-order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderData })
        });

        const result = await response.json();
        if (!result.success) {
            Swal.fire({ icon: "error", title: "Error", text: result.message });
            return;
        }

        const options = {
            key: result.key,
            amount: result.amount.toString(),
            currency: result.currency,
            name: "Aurum Scents",
            description: "Order Payment",
            order_id: result.orderId,
            handler: async function (response) {
                const verifyResponse = await fetch("/verify-payment", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature,
                        dbOrderId: result.dbOrderId,
                        couponCode: onlineCoupon
                    })
                });

                const verifyResult = await verifyResponse.json();
                if (verifyResult.success) {
                    localStorage.removeItem('appliedCoupon');
                    Swal.fire({
                        icon: "success",
                        title: "Payment Successful",
                        text: "Your payment was successful!",
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "/paymentSuccess";
                    });
                }
            },
            modal: {
                ondismiss: async function () {
                    // Handle payment cancellation or failure
                    window.location.href = "/getPaymentFail"
                }
            },
            notes: {
                dbOrderId: result.dbOrderId
            }
        };

        const rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response) {
            window.location.href = "/getPaymentFail"
        });
        rzp1.open();

    } else if (paymentMethod.value === "Wallet") {
    const couponCode = this.getAttribute('data-coupon-code');
    fetch("/checkout/process", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ orderData })
    })
    .then(response => response.json()) // Always parse JSON, regardless of status
    .then(data => {
        if (data.success) {
            localStorage.removeItem('appliedCoupon');
            Swal.fire({
                icon: "success",
                title: "Order Placed!",
                text: "Your order has been successfully placed.",
                timer: 5000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = "/paymentsuccess";
            });
        } else {
            // Handle specific error messages
            Swal.fire({
                icon: "error",
                title: "Order Failed",
                text: data.message || "Unable to place the order. Please try again."
            });
        }
    })
    .catch(error => {
        console.error("Error placing order:", error);
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "An unexpected error occurred. Please try again."
        });
    });
}
});

document.querySelectorAll('.apply-coupon').forEach(button => {
    button.addEventListener('click', function() {
        const couponCode = this.getAttribute('data-coupon-code');
        onlineCoupon = couponCode;
        console.log('Clicked apply coupon with code:', couponCode);
        applyCoupon(couponCode);
    });
});

async function applyCoupon(couponCode) {
    const totalAmountElement = document.querySelector('.product-subtotal .font-xl');
    const totalAmount = parseFloat(totalAmountElement.textContent.trim().replace('₹', '').trim()) || originalTotal;

    try {
        const response = await fetch('/apply-coupon', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ couponCode, totalAmount })
        });

        const data = await response.json();
        console.log("data: ", data);

        if (data.success) {
            updateUI(data.coupon.discountAmount);
            localStorage.setItem('appliedCoupon', JSON.stringify({
                code: couponCode,
                discountAmount: data.coupon.discountAmount
            }));
            Swal.fire({
                icon: 'success',
                title: 'Coupon Applied',
                text: `Discount of ₹${Math.floor(data.coupon.discountAmount)} applied successfully!`,
                confirmButtonText: 'OK'
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'Failed to apply coupon',
                confirmButtonText: 'OK'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to apply coupon. Please try again.',
            confirmButtonText: 'OK'
        });
    }
}

function updateUI(discountAmount) {
    const discountElement = document.querySelector('.discount-amount');
    const totalElement = document.querySelector('.product-subtotal .font-xl');

    const currentTotal = parseFloat(totalElement.textContent.trim().replace('₹', '').trim()) || originalTotal;
    const newTotal = originalTotal - discountAmount;

    discountElement.textContent = `₹${Math.floor(discountAmount)}`;
    totalElement.textContent = `₹${Math.floor(newTotal)}`;
}


//////////////////////// Razor Pay //////////////////////////////////

async function payNow() {
      const amount = document.getElementById('amount').value;

      // Create order by calling the server endpoint
      const response = await fetch('/checkout/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount, currency: 'INR', receipt: 'receipt#1', notes: {} })
      });

      const order = await response.json();

      // Open Razorpay Checkout
      const options = {
        key: 'rzp_test_fpueLavUtsLoKt', // Replace with your Razorpay key_id
        amount: '50000', // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        currency: 'INR',
        name: 'Acme Corp',
        description: 'Test Transaction',
        order_id: 'order_IluGWxBm9U8zJ8', // This is the order_id created in the backend
        callback_url: 'http://localhost:3002/payment-success', // Your success URL
        prefill: {
          name: 'Aurum Scents',
          email: 'officialaurumscents@gmail.com',
          contact: '9037223357'
        },
        theme: {
          color: '#F37254'
        },
      };

      const rzp = new Razorpay(options);
      rzp.open();
    }


    //////////////////////callback URL/////////////////////
    var options = {
    "key": "rzp_test_fpueLavUtsLoKt", // Enter the Key ID generated from the Dashboard
    "amount": "50000", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Acme Corp",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": "order_IluGWxBm9U8zJ8", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
    "prefill": {
        "name": "Aswathy Sudhakaran",
        "email": "aswathysudhakaran3002@gmail.com",
        "contact": "8123456790"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();
    e.preventDefault();
}


/////////////////////Handler Function/////////////////////
var options = {
    "key": "rzp_test_fpueLavUtsLoKt", // Enter the Key ID generated from the Dashboard
    "amount": "50000", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Acme Corp",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": "order_IluGWxBm9U8zJ8", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response){
        alert(response.razorpay_payment_id);
        alert(response.razorpay_order_id);
        alert(response.razorpay_signature)
    },
    "prefill": {
        "name": "Aswathy Sudhakaran",
        "email": "aswathysudhakaran3002@gmail.com",
        "contact": "9213456780"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
var rzp1 = new Razorpay(options);
rzp1.on('payment.failed', function (response){
        alert(response.error.code);
        alert(response.error.description);
        alert(response.error.source);
        alert(response.error.step);
        alert(response.error.reason);
        alert(response.error.metadata.order_id);
        alert(response.error.metadata.payment_id);
});
document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();
    e.preventDefault();
}
    </script>


